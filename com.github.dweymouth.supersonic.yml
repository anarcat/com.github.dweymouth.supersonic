# this doesn't work yet
#
# example flatpaks:
# https://github.com/search?q=org%3Aflathub+golang+&type=code&p=2
# https://github.com/search?q=org%3Aflathub+GLFW+&type=code
#
# followup on:
# https://discourse.flathub.org/t/supersonic-lightweight-cross-platform-desktop-client-for-subsonic-music-servers/3984/2
# https://github.com/dweymouth/supersonic/issues/86
app-id: com.github.dweymouth.supersonic
runtime: org.freedesktop.Platform
runtime-version: '22.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.golang
command: supersonic

finish-args:
  # Wayland
  #- --socket=wayland
  # from https://github.com/flathub/im.riot.Riot/blob/ff59f1ac426823e95444d67c763cd92523f1db4e/im.riot.Riot.yaml#L37
  # Required for experimental wayland support
  #- --filesystem=xdg-run/pipewire-0
  # For correct cursor scaling under Wayland
  #- --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons
  # X11 + XShm access
  - --socket=x11
  - --share=ipc
  # video acceleration in X11
  #- --device=dri
  # audio devices?
  - --device=all
  # for audio, hopefully
  - --socket=pulseaudio
  # Required to store access tokens (persistent logins)
  - --filesystem=xdg-run/keyring
  # seems like we also need those:
  # from https://github.com/flathub/com.jetbrains.IntelliJ-IDEA-Community/blob/846e9b59fc9b644782864bcc44b1e204869cc980/com.jetbrains.IntelliJ-IDEA-Community.yaml#L11
  - --talk-name=org.freedesktop.secrets
  - --talk-name=org.gnome.keyring.SystemPrompter
  # for network, obviously
  - --share=network
  #
  # System tray icon doesn't work anyway
  ## Required for notifications in various desktop environments
  #- --talk-name=org.freedesktop.Notifications
  #- --talk-name=org.kde.StatusNotifierWatcher
  ## Required for tray icons on KDE
  #- --own-name=org.kde.*
  #
  # might be useful for media keys?
  ## cargo-cult from https://github.com/flathub/com.github.iwalton3.jellyfin-mpv-shim/blob/master/com.github.iwalton3.jellyfin-mpv-shim.json
  ##- --talk-name=org.gnome.SettingsDaemon.MediaKeys

modules:
  - name: libass
    sources:
      - type: archive
        url: https://github.com/libass/libass/releases/download/0.17.1/libass-0.17.1.tar.xz
        sha256: f0da0bbfba476c16ae3e1cfd862256d30915911f7abaa1b16ce62ee653192784
        x-checker-data:
          type: anitya
          project-id: 1560
          stable-only: true
          url-template: https://github.com/libass/libass/releases/download/$version/libass-$version.tar.xz
      - type: script
        commands:
          - autoreconf -fiv
        dest-filename: autogen.sh
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share

  - name: mpv
    buildsystem: simple
    build-commands:
      - python3 waf configure --prefix=${FLATPAK_DEST} --disable-cplayer --disable-lua --disable-build-date --disable-manpage-build --disable-debug-build  --disable-tv --disable-uchardet --disable-javascript --enable-vaapi --enable-pulse --enable-alsa --enable-libmpv-shared
      - python3 waf build
      - python3 waf install
    sources:
      - type: archive
        url: https://github.com/mpv-player/mpv/archive/refs/tags/v0.35.1.tar.gz
        sha256: 41df981b7b84e33a2ef4478aaf81d6f4f5c8b9cd2c0d337ac142fc20b387d1a9
        x-checker-data:
          type: anitya
          project-id: 5348
          stable-only: true
          url-template: https://github.com/mpv-player/mpv/archive/refs/tags/v$version.tar.gz
      - type: file
        url: https://waf.io/waf-2.0.25
        sha256: 21199cd220ccf60434133e1fd2ab8c8e5217c3799199c82722543970dc8e38d5
        dest-filename: waf
        x-checker-data:
          type: anitya
          project-id: 5116
          stable-only: true
          url-template: https://waf.io/waf-$version

  # this is used to bundle the final supersonic command correctly and
  # provides the /app/bin/fyne command to the next module
  - name: finecmd
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/golang/bin
      env:
        GOBIN: /app/bin
      # TODO: remove this and get each dependency properly, then add
      # `GO111MODULE: off` above
      #
      # package list could be generated with:
      # https://github.com/divVerent/aaaaxy/blob/main/scripts/go-vendor-to-flatpak-yml.sh
      # https://github.com/flathub/com.yktoo.ymuse/blob/7c33add48cfc6788b9ddf0c92ee7213f40c6c78e/com.yktoo.ymuse.yml#L57-L63
      #
      # this doesn't work so well:
      # https://github.com/flatpak/flatpak-builder-tools/tree/master/go-get
      # ... because it generates git links, which are much slower
      #
      # other examples:
      # https://github.com/flathub/me.kozec.syncthingtk/blob/cf25336132b96c514f29d5a5322874e847aba150/syncthing.yaml
      #
      # also used:
      # https://github.com/search?q=org%3Aflathub+++mpv&type=code
      build-args:
        - --share=network
    build-commands:
      - . /usr/lib/sdk/golang/enable.sh && go install -v fyne.io/fyne/v2/cmd/fyne@v2.3.3

  - name: supersonic
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/golang/bin
      env:
        GOBIN: /app/bin
      # TODO: remove this and get each dependency properly, then add
      # `GO111MODULE: off` above
      build-args:
        - --share=network
    build-commands:
      - . /usr/lib/sdk/golang/enable.sh && CGO_LDFLAGS=-L/app/lib go build -v .
      - . /usr/lib/sdk/golang/enable.sh && CGO_LDFLAGS=-L/app/lib /app/bin/fyne package -os linux -name Supersonic -icon ./res/appicon-500.png
      - tar -C /app --strip-components=1 -x -v -f /run/build/supersonic/Supersonic.tar.xz
      - ls -al /app/bin/supersonic
    sources:
      - type: archive
        url: https://github.com/dweymouth/supersonic/archive/refs/tags/v0.1.0-beta.tar.gz
        sha256: 4baeea51f759c6571bb0e6450e3928838640bb9df80bded77cd8a15528c85163
    post-install:
      # workaround for go annoyance
      - chmod -R u+w $FLATPAK_BUILDER_BUILDDIR
